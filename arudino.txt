#include <SoftwareSerial.h>
#include <ArduinoJson.h>

int doam;

// Định nghĩa các chân kết nối UART trên ESP8266
const int rxPin = 10;  // RX pin
const int txPin = 11;  // TX pin

// Khởi tạo đối tượng SoftwareSerial
SoftwareSerial mySerial(rxPin, txPin);
//KHởi tạo Json gửi
StaticJsonDocument<50> doc;
StaticJsonDocument<50> gui;

#define sensorPower 7
#define sensorPin A0


void setup() {
  // Khởi tạo cổng Serial với baud rate 9600
  Serial.begin(9600);
  // Khởi tạo cổng UART với baud rate 19200
  mySerial.begin(19200);

  pinMode(12,OUTPUT);
  pinMode(13, OUTPUT);
}
int readSensor() {
	digitalWrite(sensorPower, HIGH);	
	delay(10);							
	int val = analogRead(sensorPin);	
  int phantram = map(val,0,1023,1,100);
 	int phantramthuc = 100 - phantram;
	digitalWrite(sensorPower, LOW);		
	return phantramthuc;							
}

void loop() {
  doam = readSensor();
  Serial.println(doam);
  gui["doam"] = doam;

  // Chuyển đổi đối tượng JsonDocument thành chuỗi JSON và gửi nó qua cổng nối tiếp ảo
  serializeJson(gui, mySerial);
  mySerial.println();

  serializeJson(gui, Serial);
  Serial.println();

  if (mySerial.available()) {
    // Đọc một dòng từ cổng nối tiếp ảo
    String line = mySerial.readStringUntil('\n');

    // Chuyển đổi chuỗi JSON thành đối tượng JsonDocument
    DeserializationError error = deserializeJson(doc, line);

    // Kiểm tra xem có lỗi nào trong quá trình chuyển đổi hay không
    if (error) {
      Serial.print("deserializeJson() failed: ");
      Serial.println(error.c_str());
      return;
    }

    // Lấy giá trị nhiệt độ và độ ẩm từ đối tượng JsonDocument
    int ttled1 = doc["led1"];
    // In các giá trị ra màn hình nối tiếp
    if(ttled1 == 1){
      digitalWrite(12, HIGH);
    }
    else digitalWrite(12, LOW);
  }
  delay(3000);
}